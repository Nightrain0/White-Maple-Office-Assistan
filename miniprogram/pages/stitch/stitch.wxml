<view class="container">
  
  <!-- 图片列表区 -->
  <scroll-view 
    scroll-y 
    scroll-x="{{true}}" 
    class="preview-box {{mode === 'horizontal' ? 'scroll-h' : ''}}" 
    style="background-color: {{bgColor}};"
  >
    
    <!-- 布局容器 -->
    <view 
      class="canvas-mock layout-{{mode}}" 
      style="padding: {{padding}}px; gap: {{gap}}px; {{mode==='grid' ? 'grid-template-columns: repeat(' + gridCols + ', 1fr);' : ''}}"
    >
      
      <block wx:for="{{images}}" wx:key="index">
        <view 
          class="img-wrapper {{mode==='horizontal' ? 'inline-wrapper' : ''}}" 
          style="border-radius: {{radius}}px; {{mode==='grid' ? 'aspect-ratio: ' + gridRatio + ' / 1;' : ''}}"
        >
          <!-- 
             Grid 模式下强制 aspectFit，保证内容不丢失。
             用户可以通过调节 gridRatio 来消除留白。
          -->
          <image 
            src="{{item.path}}" 
            mode="{{mode==='horizontal' ? 'heightFix' : (mode==='grid' ? 'aspectFit' : 'widthFix')}}" 
            class="img-item"
            style="border-radius: {{radius}}px;"
          >
          </image>
          <view class="del-btn" catchtap="remove" data-index="{{index}}">×</view>
        </view>
      </block>
      
      <!-- 添加按钮 -->
      <view 
        class="add-btn img-wrapper {{mode==='horizontal' ? 'inline-wrapper' : ''}}" 
        bindtap="addImages" 
        style="border-radius: {{radius}}px; {{mode==='grid' ? 'aspect-ratio: ' + gridRatio + ' / 1;' : ''}}"
      >
        <text>➕ 添加</text>
      </view>

    </view>
  </scroll-view>

  <!-- 控制面板 -->
  <view class="controls">
    
    <view class="tabs">
      <view class="tab {{mode==='vertical'?'active':''}}" bindtap="setMode" data-mode="vertical">↕️ 纵向</view>
      <view class="tab {{mode==='horizontal'?'active':''}}" bindtap="setMode" data-mode="horizontal">↔️ 横向</view>
      <view class="tab {{mode==='grid'?'active':''}}" bindtap="setMode" data-mode="grid">🔲 宫格</view>
    </view>

    <!-- 宫格专属设置 -->
    <view wx:if="{{mode === 'grid'}}" style="margin-bottom: 10rpx;">
        <view class="slider-row">
            <text class="label">列数</text>
            <slider class="slider" value="{{gridCols}}" min="2" max="5" bindchange="setGridCols" block-size="18" show-value/>
        </view>
        <view class="slider-row">
            <text class="label">比例</text>
            <slider class="slider" value="{{gridRatio}}" min="0.5" max="2" step="0.1" bindchange="setGridRatio" block-size="18"/>
            <text class="value-tip">{{gridRatio < 0.9 ? '竖长' : (gridRatio > 1.1 ? '横长' : '正方')}}</text>
        </view>
    </view>

    <!-- 通用样式 -->
    <view class="slider-row">
      <text class="label">间距</text>
      <slider class="slider" value="{{gap}}" min="0" max="30" bindchange="setGap" block-size="18"/>
      <text class="label">边距</text>
      <slider class="slider" value="{{padding}}" min="0" max="30" bindchange="setPadding" block-size="18"/>
    </view>
    <view class="slider-row">
      <text class="label">圆角</text>
      <slider class="slider" value="{{radius}}" min="0" max="50" bindchange="setRadius" block-size="18"/>
    </view>

    <view class="color-row">
      <text class="label">背景</text>
      <view class="colors">
        <view wx:for="{{colors}}" wx:key="*this" 
              class="color-dot {{bgColor===item?'active':''}}" 
              style="background:{{item}}; border: 1rpx solid #ddd;" 
              bindtap="setColor" data-color="{{item}}">
        </view>
      </view>
    </view>

    <button class="btn-main" bindtap="stitch" loading="{{isProcessing}}">生成高清长图</button>
  </view>

  <canvas type="2d" id="stitchCanvas" style="position:fixed; left:9000px;"></canvas>
</view>